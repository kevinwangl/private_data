# 负债数据空白问题修复报告

## 问题描述
Excel输出文件中的负债数据部分（经营性负债和金融性负债）显示为空白。

## 根本原因
1. **数据源未获取负债明细**：`akshare.rs`中的`fetch_balance_sheet_data`函数只获取了少量字段（资产总计、负债合计、货币资金、固定资产、应收账款、存货、股本），但没有获取负债明细科目。

2. **Excel代码期望的字段缺失**：Excel生成代码中使用了16个负债科目（应付票据、应付账款、预收款项、应付职工薪酬、应交税费、合同负债、递延所得税负债、递延收益、应付利息、应付股利、应付债券、交易性金融负债、长期应付款、长期借款、短期借款、一年内到期的非流动负债），但这些字段在数据源中都没有返回。

3. **年份数量假设错误**：代码假设总是有3年数据，但实际可能只有2年，导致索引越界错误。

## 修复方案

### 1. 扩展AkshareBalanceSheet结构体
在`src/data_source/akshare.rs`中添加了16个负债相关字段：
```rust
#[serde(rename = "NOTES_PAYABLE")]
notes_payable: Option<f64>,
#[serde(rename = "ACCOUNTS_PAYABLE")]
accounts_payable: Option<f64>,
// ... 其他14个字段
```

### 2. 修改Python脚本获取负债数据
在`fetch_balance_sheet_data`函数的Python脚本中添加了所有负债科目的获取：
```python
'NOTES_PAYABLE': safe_float(row.get('应付票据')),
'ACCOUNTS_PAYABLE': safe_float(row.get('应付账款')),
'ADVANCE_RECEIPTS': safe_float(row.get('预收款项')),
// ... 其他科目
```

### 3. 将负债数据写入items_map
在数据转换部分添加了所有负债科目到items_map：
```rust
items_map.insert("应付票据".to_string(), Decimal::from_f64_retain(item.notes_payable.unwrap_or(0.0)).unwrap_or(Decimal::ZERO));
items_map.insert("应付账款".to_string(), Decimal::from_f64_retain(item.accounts_payable.unwrap_or(0.0)).unwrap_or(Decimal::ZERO));
// ... 其他科目
```

### 4. 修复年份数量问题
在`src/analyzer/mod.rs`中添加了默认年份处理：
```rust
let years = if years.is_empty() {
    let current_year = chrono::Local::now().year();
    vec![current_year - 1, current_year - 2, current_year - 3]
} else {
    years
};
```

在`src/excel/mod.rs`中修改了所有硬编码的年份索引，改为动态处理：
```rust
let num_years = years.len().min(3);
for (i, year) in years.iter().take(num_years).enumerate() {
    worksheet.write_string_with_format(1, 2 + i as u16, year.to_string(), &header_fmt)?;
}
```

## 修复结果
运行修复后的程序：
```bash
cargo run -- analyze --stock 300144 --source akshare --output 300144_SH_财务分析_修复.xlsx
```

成功生成Excel文件，负债数据已正确填充：

**经营性负债**：
- 应付账款：293,238,200 (2023年)
- 预收款项：25,735,270 (2023年)
- 应付职工薪酬：27,725,420 (2023年)
- 应交税费：75,181,850 (2023年)
- 合同负债：89,718,760 (2023年)
- 递延所得税负债：699,400 (2023年)

**金融性负债**：
- 长期借款：67,500,000 (2023年)
- 一年内到期的非流动负债：54,623,390 (2023年)

**负债合计**：1,384,492,000 (2023年)

## 修改的文件
1. `src/data_source/akshare.rs` - 添加负债字段和数据获取
2. `src/analyzer/mod.rs` - 添加默认年份处理
3. `src/excel/mod.rs` - 修复年份数量假设问题

## 测试验证
✅ 编译成功
✅ 程序运行成功
✅ Excel文件生成成功
✅ 负债数据正确填充
✅ 支持不同数量的年份（2年或3年）
