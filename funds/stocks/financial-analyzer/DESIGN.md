# 财务分析系统设计文档

> 更新时间: 2026-01-15

## 1. 系统概述

基于Rust的财务分析系统，支持从AKShare/Tushare获取A股财务数据，生成包含资产负债分析、利润现金流分析、DCF估值和唐朝估值的Excel报告。

## 2. 数据模型

### 2.1 核心结构

```rust
pub struct FinancialStatement {
    pub stock_code: String,
    pub report_date: NaiveDate,
    pub report_type: ReportType,      // BalanceSheet | IncomeStatement | CashflowStatement
    pub items: HashMap<String, Decimal>,
}

pub struct AnalysisResult {
    pub stock_code: String,
    pub years: Vec<i32>,
    pub asset_structure: AssetStructureAnalysis,
    pub profit_analysis: ProfitAnalysis,
    pub valuation: Option<ValuationResult>,
    pub statements: Vec<FinancialStatement>,
}
```

### 2.2 关键科目映射

| 类别 | 科目名称 | 数据源字段 |
|------|----------|------------|
| 利润表 | 营业总收入 | 营业总收入 / 营业收入 |
| 利润表 | 营业成本 | 营业成本 (用于毛利计算) |
| 利润表 | 营业总成本 | 营业总成本 / 营业支出 |
| 利润表 | 管理费用 | 管理费用 / 业务及管理费 (保险) |
| 利润表 | 业务及管理费 | 业务及管理费 (保险公司专用) |
| 现金流 | 资本支出 | 购建固定资产、无形资产和其他长期资产支付的现金 |
| 资产负债 | 所有者权益 | 所有者权益(或股东权益)合计 / 所有者权益合计 |

## 3. Excel报表结构

### Sheet1: 资产&负债结构分析
简化视图，引用Sheet2数据

### Sheet2: (经营性&金融性)资产&负债结构分析

**左侧 - 资产 (A-E列)**
| 行号 | 内容 |
|------|------|
| 2 | 年份标题 |
| 4-10 | 经营性资产 (货币资金、固定资产、应收票据、应收账款、预付款项、存货、无形资产) |
| 11-20 | 金融性资产 (交易性金融资产、长期股权投资等) |
| 21 | 资产合计 |
| 22 | 经营性资产占比 (黄色高亮) |
| 23 | 金融性资产占比 |

**右侧 - 负债 (G-K列)**
| 行号 | 内容 |
|------|------|
| 4-11 | 经营性负债 (应付票据、应付账款等) |
| 12-19 | 金融性负债 (短期借款、长期借款等) |
| 20 | 负债合计 |
| 21 | 股东权益合计 |
| 22 | 经营性负债占比 (黄色高亮) |
| 23 | 金融性负债占比 |

### Sheet3: 利润&现金流结构分析

**左侧 - 利润表 (B-E列)**
| 行号 | 内容 |
|------|------|
| 3 | 营业总收入 |
| 4 | 营业成本 |
| 5 | 营业总成本 |
| 6-10 | 费用项 (税金、销售、管理、研发、财务) |
| 11-15 | 其他收益项 |
| 17-19 | 营业外收支、净利润 |
| 20 | **毛利** = C3-C4 |
| 21 | 毛利率 |
| 22 | **核心利润** = C20-C6-C7-C8-C9-C10 |
| 23-28 | 其他比率 |

**中间 - 现金流 (G-K列)**
| 行号 | 内容 |
|------|------|
| 4 | 经营活动现金流净额 |
| 5 | 资本性支出 |
| 6 | 投资支付的现金 |
| 7 | 投资活动现金流净额 |
| 8-14 | 筹资活动现金流 |
| 15 | **自由现金流** = I4-I5 |

**DCF估值 (F-H列, 行16-26)**
| 行号 | 内容 | 公式 |
|------|------|------|
| 16 | 基准FCF | =I15 |
| 17 | 折现率(r) | 0.08 |
| 18 | 永续增长率(g) | 0.04 |
| 19 | FCF增长率(G) | =MIN(0.15,MAX(-0.1,POWER(I15/K15,1/2)-1)) |
| 20 | 总股本 | 从资产负债表获取 |
| 21-24 | 各年现值 | DCF公式 |
| 25 | 企业价值 | =SUM(H21:H24) |
| 26 | **每股价值** | =H25/H20 (黄色高亮) |

**唐朝估值 (F-I列, 行28-33)**
| 行号 | 内容 | 公式 |
|------|------|------|
| 28 | 净利润增长率 | 0.10 |
| 29 | 低估PE | 1/0.04=25 |
| 30 | 高估PE | 1/0.02=50 |
| 31 | **低估买入点** | =(C19*POWER(1+H28,3))*J29 |
| 32 | 7折买入点 | =H31*0.7 |
| 33 | **高估卖出点** | =(C19*POWER(1+H28,3))*J30 |

### Sheet4: 综合实力分析
- ROE = 净利润(C19) / 股东权益(I21)
- ROA = 净利润(C19) / 资产总计(C21)
- 核心利润引用Sheet3的C22

### Sheet5: 资产负债表分析视角
关键科目的简化展示

## 4. 关键公式说明

### 4.1 毛利计算 (已修复)
```
毛利 = 营业总收入 - 营业成本
```
**注意**: 使用"营业成本"而非"营业总成本"，后者包含期间费用

### 4.2 核心利润计算 (已修复)
```
核心利润 = 毛利 - 税金及附加 - 销售费用 - 管理费用 - 研发费用 - 财务费用
```
**注意**: 基于毛利计算，避免重复扣除费用

### 4.3 自由现金流
```
FCF = 经营活动现金流净额 - 资本性支出
```

### 4.4 DCF估值
```
FCF增长率(G) = MIN(15%, MAX(-10%, (FCF_t/FCF_t-2)^0.5 - 1))
```
**限制**: 增长率限制在-10%~15%，防止异常值导致估值失真

```
企业价值 = Σ(FCF*(1+G)^n / (1+r)^n) + 永续年金现值
永续年金 = FCF*(1+G)^3*(1+g) / (r-g) / (1+r)^3
每股价值 = 企业价值 / 总股本
```

### 4.5 唐朝估值
```
3年后净利润 = 当前净利润 * (1+增长率)^3
低估买入点 = 3年后净利润 * 25 (PE=25)
高估卖出点 = 3年后净利润 * 50 (PE=50)
```

## 5. 数据源适配

### 5.1 AKShare (推荐)
- 免费、无需Token
- 通过Python脚本调用
- 支持新浪财经数据

### 5.2 保险公司特殊处理
| 普通公司 | 保险公司 |
|----------|----------|
| 销售费用 | 无 (显示为0) |
| 管理费用 | 业务及管理费 |
| 营业外收入 | 加:营业外收入 |
| 所有者权益合计 | 所有者权益合计 (无"或股东权益") |

## 6. 输出

### 6.1 Excel文件
- 5个工作表
- 自动计算公式
- 格式化样式 (千分位、百分比、高亮)

### 6.2 文本报告
- 控制台输出
- 保存为.txt文件
- 包含所有关键指标

## 7. 使用示例

```bash
# 分析茅台最近3年数据
cargo run -- analyze --stock 600519 --source akshare --years 2024,2023,2022

# 分析平安保险
cargo run -- analyze --stock 601318 --source akshare --years 2024,2023,2022

# 指定输出文件
cargo run -- analyze --stock 600519 --source akshare --years 2024,2023,2022 --output 茅台分析.xlsx
```

## 8. 已知限制

1. 仅支持年报数据 (12月31日)
2. DCF估值对FCF波动敏感，已添加增长率上限
3. 保险/银行等金融企业部分指标不适用
4. 依赖AKShare/新浪财经API可用性

## 9. 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2026-01-14 | 初始版本 |
| 1.1 | 2026-01-15 | 修复毛利计算、核心利润计算 |
| 1.2 | 2026-01-15 | 添加FCF增长率上限(-10%~15%) |
| 1.3 | 2026-01-15 | 添加业务及管理费独立字段 |
| 1.4 | 2026-01-15 | 删除重复函数、修复毛利结构体计算 |
